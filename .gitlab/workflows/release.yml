pages-build:
  artifacts:
    paths:
      - public
      - docs/changelog.md
      - release-notes.md
  cache:
    paths:
      - .venv
    key:
      files:
        - pdm.lock
      prefix: venv-${PYTHON_VERSION}
    policy: pull
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-?(a|b|rc)(0|[1-9][0-9]*)?)?$/
  script:
    - make dev-doc
    - make doc
    - make release-notes > release-notes.md
  stage: release
release-publish:
  image: registry.gitlab.com/gitlab-org/release-cli:v0.18.0@sha256:696013aea0f2a20482800ce3a77341f840d7c7ec17bd78bd555e0bd6c00e4f11
  needs:
    - pages-build
  release:
    description: release-notes.md
    tag_name: $CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-?(a|b|rc)(0|[1-9][0-9]*)?)?$/
  script:
    - echo "Running the release job."
  stage: release
  variables:
    GIT_STRATEGY: none
container-publish:
  image: docker:26.1.2@sha256:c890c327e515cdccd14e593fb5450e4375e791ab0520795948134cb87b45aaa7
  needs:
    - release-publish
  parallel:
    matrix:
      - PYTHON_VERSION:
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-?(a|b|rc)(0|[1-9][0-9]*)?)?$/
  script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
    - docker context create builder
    - docker buildx create builder --name container --driver docker-container --use
    - docker buildx inspect --bootstrap --builder container
    - |
      docker buildx build . \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/dev-cache:py${PYTHON_VERSION} \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/dev-cache:py${PYTHON_VERSION},mode=max \
        --file .devcontainer/Dockerfile \
        --load \
        --tag ${CI_REGISTRY_IMAGE}/dev:py${PYTHON_VERSION} \
        --tag ${CI_REGISTRY_IMAGE}/dev:py${PYTHON_VERSION}-${CI_COMMIT_TAG} \
        --target dev
    - |
      docker run --rm \
        -e CI_PAGES_URL \
        -v ${PWD}:/workspace \
        ${CI_REGISTRY_IMAGE}/dev:py${PYTHON_VERSION} \
        make dev lint test doc build
    - |
      docker buildx build . \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        --file .devcontainer/Dockerfile \
        --push \
        --tag ${CI_REGISTRY_IMAGE}/dev:py${PYTHON_VERSION} \
        --tag ${CI_REGISTRY_IMAGE}/dev:py${PYTHON_VERSION}-${CI_COMMIT_TAG} \
        --target dev
    - |
      docker buildx build . \
        --build-arg PDM_BUILD_SCM_VERSION=${CI_COMMIT_TAG} \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        --file .devcontainer/Dockerfile \
        --load \
        --tag ${CI_REGISTRY_IMAGE}:py${PYTHON_VERSION} \
        --tag ${CI_REGISTRY_IMAGE}:py${PYTHON_VERSION}-${CI_COMMIT_TAG} \
        --target prod
    - docker run --rm ${CI_REGISTRY_IMAGE}:py${PYTHON_VERSION}
    - |
      docker buildx build . \
        --build-arg PDM_BUILD_SCM_VERSION=${CI_COMMIT_TAG} \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        --file .devcontainer/Dockerfile \
        --push \
        --tag ${CI_REGISTRY_IMAGE}:py${PYTHON_VERSION} \
        --tag ${CI_REGISTRY_IMAGE}:py${PYTHON_VERSION}-${CI_COMMIT_TAG} \
        --target prod
  services:
    - docker:26.1.2@sha256:c890c327e515cdccd14e593fb5450e4375e791ab0520795948134cb87b45aaa7
  stage: release
  variables:
    DOCKER_TLS_CERTDIR: /certs
    PYTHON_VERSION: ${PYTHON_VERSION}
    SOURCE_DATE_EPOCH: 0
package-publish:
  needs:
    - release-publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-?(a|b|rc)(0|[1-9][0-9]*)?)?$/
  script:
    - make publish
  stage: release
pages:
  artifacts:
    paths:
      - public
  needs:
    - pages-build
    - release-publish
    - container-publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-?(a|b|rc)(0|[1-9][0-9]*)?)?$/
  script:
    - echo "Running the pages job."
  stage: release
  variables:
    GIT_STRATEGY: none
